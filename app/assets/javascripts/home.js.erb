var map;
var currentTarget;
var existsCurrentTarget = false;
var defaultRadius = 100;

$(document).ready(function(){

  // Only numbers in radius field validation.
  $("#index-dynamic-container").on('keydown', "#target_radius", function (e) {
    validateNumericInput(e);
  });

  // Resizing of target radius
  $("#index-dynamic-container").on('focusout', "#target_radius", function () {

    var newradius = parseInt($('#target_radius').val());

    if(newradius > 0 && newradius < 1000) {
      currentTarget.setRadius(newradius);
      defaultRadius = newradius;
    } else {
      $('#target_radius').val('');
    }
  });

  // Click on topics table. Background color changes and icon is set to target on map.
  $("#index-dynamic-container").on('click', "#topic-table > tbody > tr", function () {

    //Set previously selected row background back to white and the clicked one to light gray.
    $('.selected').removeClass('selected');
    $(this).addClass('selected');

    //Sets topic_id to hidden form input.
    var topicId = $(this).attr('topic-id');
    $('#target_topic_id').val(topicId);

  });
});

function initMap() {

  var mapOptions = {
      zoom: 15,
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      disableDefaultUI: true
  };

  map = new google.maps.Map(document.getElementById('map'), mapOptions);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      var marker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: "<%= asset_path('marker.png') %>"
      });

      map.setCenter(pos);

    }, function(e) {
      console.log(e);
    });
  }

  map.addListener('click', function(e) {
    newTarget(e);
  });

  google.maps.event.addListenerOnce(map, 'idle', function(){
    loadUserTargets();
  });
}

function loadUserTargets() {
  $.getJSON('/targets/list', function(targetsList) {
    jQuery.each(targetsList, function(index, target){
      var targetsCenter = new google.maps.LatLng(target.latitude, target.longitude);
      drawCircleAt(targetsCenter, target.radius);
    });
  });
}

function validateNumericInput(e) {
  // Allow: backspace, delete, tab, escape, enter and .
  if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
    // Allow: Ctrl/cmd+A
    (e.keyCode == 65 && (e.ctrlKey === true || e.metaKey === true)) ||
     // Allow: Ctrl/cmd+C
    (e.keyCode == 67 && (e.ctrlKey === true || e.metaKey === true)) ||
     // Allow: Ctrl/cmd+X
    (e.keyCode == 88 && (e.ctrlKey === true || e.metaKey === true)) ||
     // Allow: home, end, left, right
    (e.keyCode >= 35 && e.keyCode <= 39)) {
         // let it happen, don't do anything
      return;
  }

  // Ensure that it is a number and stop the keypress
  if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
    e.preventDefault();
  }
}

function newTarget(e) {
  if(!existsCurrentTarget){
    existsCurrentTarget = true;
    $.getJSON('/targets/load_create_form', function(data) {
      $("#index-dynamic-container").html(data.form);
      setCurrentTarget(drawCircleAt(e.latLng, defaultRadius));
    });
  }
  else {
    currentTarget.setMap(null);
    setCurrentTarget(drawCircleAt(e.latLng, defaultRadius));
  }
}

function drawCircleAt(location, radius) {

  var circle = new google.maps.Circle({
    strokeWeight: 0,
    fillColor: '#efc537',
    fillOpacity: 0.7,
    map: map,
    center: location,
    radius: radius
  });

  google.maps.event.addListener(circle, 'click', function(e) {
    newTarget(e);
  });

  return circle;
}

function setCurrentTarget(t) {
  currentTarget = t;
  $('#target_latitude').val(t.getCenter().lat());
  $('#target_longitude').val(t.getCenter().lng());
  $('#target_radius').val(defaultRadius);
}

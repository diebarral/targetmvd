var map, currentTarget, latDiff, lngDiff;
var existsCurrentTarget = false;
var defaultRadius = 100;

$(document).ready(function(){

  // Only numbers in radius field validation.
  $("#index-dynamic-container").on('keydown', "#target_radius", function (e) {
    validateNumericInput(e);
  });

  // Resize of target on radius change
  $("#index-dynamic-container").on('focusout', "#target_radius", function () {

    var newradius = parseInt($('#target_radius').val());

    if(newradius > 0 && newradius < 1000) {
      currentTarget.setRadius(newradius);
      defaultRadius = newradius;
    } else {
      $('#target_radius').val('');
    }
  });

  // Click on topics table. Background color changes and icon is set to target on map.
  $("#index-dynamic-container").on('click', "#topic-table > tbody > tr", function () {

    //Set previously selected row background back to white and the clicked one to light gray.
    $('.selected').removeClass('selected');
    $(this).addClass('selected');

    //Sets topic_id to hidden form input.
    var topicId = $(this).attr('topic-id');
    $('#target_topic_id').val(topicId);

  });

  $("#index-dynamic-container").on('click', '#edit-user-submit', function (e) {
    e.preventDefault();
    var data, url;

    if($('#new_user').length){
      data = $('#new_user').serialize();
      url = $('#new_user').attr('action');
    }
    else {
      data = $('#edit_user').serialize();
      url = $('#edit_user').attr('action');
    }

    $.ajax({
      url: url,
      type: 'PUT',
      data: data,
      success: function(result) {
        $("#index-dynamic-container").html(result.form);
      }
    });
  });
});



function initMap() {

  $(document).on('turbolinks:load', function() {
    initMap();
  });

  var mapOptions = {
      zoom: 15,
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      disableDefaultUI: true
  };

  map = new google.maps.Map(document.getElementById('map'), mapOptions);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      var marker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: "<%= asset_path('marker.png') %>"
      });

      map.setCenter(pos);

    }, function(e) {
      console.log(e);
    });
  }

  map.addListener('click', function(e) {
    newTarget(e);
  });

  google.maps.event.addListenerOnce(map, 'idle', function(){
    loadUserTargets();
  });

  map.addListener('drag', function(e) {
    if(existsCurrentTarget) {
      currentTarget.setCenter(new google.maps.LatLng(map.getCenter().lat() + latDiff, map.getCenter().lng() + lngDiff));
      setCurrentTarget(currentTarget);
    }
  });
}

function loadUserTargets() {
  $.getJSON('/targets/list', function(targetsList) {
    jQuery.each(targetsList, function(index, target){
      var targetsCenter = new google.maps.LatLng(target.latitude, target.longitude);
      drawCircleAt(targetsCenter, target.radius, target.id);
    });
  });
}

function validateNumericInput(e) {
  // Allow: backspace, delete, tab, escape, enter and .
  if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
    // Allow: Ctrl/cmd+A
    (e.keyCode == 65 && (e.ctrlKey === true || e.metaKey === true)) ||
     // Allow: Ctrl/cmd+C
    (e.keyCode == 67 && (e.ctrlKey === true || e.metaKey === true)) ||
     // Allow: Ctrl/cmd+X
    (e.keyCode == 88 && (e.ctrlKey === true || e.metaKey === true)) ||
     // Allow: home, end, left, right
    (e.keyCode >= 35 && e.keyCode <= 39)) {
         // let it happen, don't do anything
      return;
  }

  // Ensure that it is a number and stop the keypress
  if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
    e.preventDefault();
  }
}

function newTarget(e) {
  if(!existsCurrentTarget){
    existsCurrentTarget = true;
    $.getJSON('/targets/load_create_form', function(data) {
      $("#index-dynamic-container").html(data.form);
      setCurrentTarget(drawCircleAt(e.latLng, defaultRadius, 0));
    });
  }
  else {
    currentTarget.setMap(null);
    setCurrentTarget(drawCircleAt(e.latLng, defaultRadius, 0));
  }
}

function drawCircleAt(location, radius, targetId) {

  var circle = new google.maps.Circle({
    strokeWeight: 0,
    fillColor: '#efc537',
    fillOpacity: 0.7,
    map: map,
    center: location,
    radius: radius,
    targetId: targetId
  });

  if(targetId != 0) {
    google.maps.event.addListener(circle, 'click', function(e) {
      editTarget(circle, targetId);
    });
  }

  return circle;
}

function editTarget(target, targetId) {

  currentTarget = target;
  $.getJSON('/targets/edit', { id: targetId }, function(data) {
    $("#index-dynamic-container").html(data.form);
  }).done(function(){
    var topicId = $('#target_topic_id').val();
    $('#topic-table tbody tr[topic-id=' + topicId + ']').addClass('selected');
  });
}

function setCurrentTarget(target) {
  currentTarget = target;

  latDiff = target.getCenter().lat() - map.getCenter().lat();
  lngDiff = target.getCenter().lng() - map.getCenter().lng();

  $('#target_latitude').val(target.getCenter().lat());
  $('#target_longitude').val(target.getCenter().lng());
  $('#target_radius').val(defaultRadius);
}

var map;
var currentTarget;
var existsCurrentTarget = false;

$(document).ready(function(){

  // Only numbers in radius field validation.
  $("#index-dynamic-container").on('keydown', "#target_radius", function (e) {
    // Allow: backspace, delete, tab, escape, enter and .
    if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
      // Allow: Ctrl/cmd+A
      (e.keyCode == 65 && (e.ctrlKey === true || e.metaKey === true)) ||
       // Allow: Ctrl/cmd+C
      (e.keyCode == 67 && (e.ctrlKey === true || e.metaKey === true)) ||
       // Allow: Ctrl/cmd+X
      (e.keyCode == 88 && (e.ctrlKey === true || e.metaKey === true)) ||
       // Allow: home, end, left, right
      (e.keyCode >= 35 && e.keyCode <= 39)) {
           // let it happen, don't do anything
        return;
    }

    // Ensure that it is a number and stop the keypress
    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
      e.preventDefault();
    }
  });

  // Resizing of target radius
  $("#index-dynamic-container").on('focusout', "#target_radius", function () {

    var newradius = parseInt($('#target_radius').val());

    if(newradius > 0 && newradius < 1000) {
      currentTarget.setRadius(newradius);
    } else {
      $('#target_radius').val('');
    }
  });

  // Click on topics table. Background color changes and icon is set to target on map.
  $("#index-dynamic-container").on('click', "#topic-table > tbody > tr", function () {

    //Sets all rows background back to white.
    $("#topic-table > tbody > tr").each(function() {
      $(this).css('background-color','#ffffff');
    });

    //Sets clicked row background to light gray.
    $(this).css("background-color", "#f4f4f4");

    //Sets topic_id to hidden form input.
    $('#target_topic_id').val($(this).attr('topic-id'));

  });

});

function initMap() {

  var mapOptions = {
      zoom: 15,
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      disableDefaultUI: true
  };

  map = new google.maps.Map(document.getElementById('map'), mapOptions);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      var marker = new google.maps.Marker({
          position: pos,
          map: map,
          icon: "<%= asset_path('marker.png') %>"
        });

      map.setCenter(pos);

    }, function(e) {
      console.log(e);
    });
  }

  map.addListener('click', function(e){

    if(!existsCurrentTarget){
      existsCurrentTarget = true;
      $.get('/targets/load_create_target').done(function(){
        placeTarget(e.latLng);
      });
    }
    else {
      currentTarget.setMap(null);
      placeTarget(e.latLng)
    }
  });
}

function placeTarget(location) {

  var defaultRadius = 100;

  var target = new google.maps.Circle({
    strokeWeight: 0,
    fillColor: '#efc537',
    fillOpacity: 0.7,
    map: map,
    center: location,
    radius: defaultRadius
  });

  currentTarget = target;
  $('#target_latitude').val(location.lat());
  $('#target_longitude').val(location.lng());
  $('#target_radius').val(defaultRadius);
}



